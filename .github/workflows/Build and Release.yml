name: SpotveeC Patch with Cyan Integration

on:
  workflow_dispatch:
    inputs:
      SPOTURL:
        description: 'URL to the vanilla Spotify IPA'
        required: true
        type: string
      CHANGEVERSION:
        description: 'Optional SpotveeC version'
        required: false
        type: string
      USEACTIONSEEVEE:
        description: 'Use EeveeSpotify from GitHub Actions artifacts'
        required: true
        type: boolean
      EEVEEVERSION:
        description: 'EeveeSpotify version'
        required: false
        type: string
      EEVEEREPO:
        description: 'EeveeSpotify repository'
        required: false
        type: string

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipx
          pipx install --force https://github.com/SpotCompiled/pyzule-rw/archive/main.zip

      - name: Set environment variables
        run: |
          echo "SPOTURL=${{ github.event.inputs.SPOTURL }}" >> $GITHUB_ENV
          echo "CHANGEVERSION=${{ github.event.inputs.CHANGEVERSION }}" >> $GITHUB_ENV
          echo "USEACTIONSEEVEE=${{ github.event.inputs.USEACTIONSEEVEE }}" >> $GITHUB_ENV
          echo "EEVEEVERSION=${{ github.event.inputs.EEVEEVERSION }}" >> $GITHUB_ENV
          echo "EEVEEREPO=${{ github.event.inputs.EEVEEREPO }}" >> $GITHUB_ENV

      - name: Download and verify components
        run: |
          # Download and verify Spotify IPA
          curl -L -o spotify.ipa $SPOTURL
          # Add verification steps as needed

          # Download and verify EeveeSpotify .deb
          if [ "$USEACTIONSEEVEE" = "true" ]; then
            curl -L -o eeveespotify.deb "https://github.com/${EEVEEREPO}/releases/download/${EEVEEVERSION}/eeveespotify.deb"
          else
            curl -L -o eeveespotify.deb "https://github.com/EeveeSpotify/EeveeSpotify/releases/download/${EEVEEVERSION}/eeveespotify.deb"
          fi
          # Add verification steps as needed

      - name: Apply Cyan patch
        run: |
          python -m pyzule.main patch \
            --ipa spotify.ipa \
            --deb eeveespotify.deb \
            --output patched_spotify.ipa

      - name: Upload patched IPA
        uses: actions/upload-artifact@v3
        with:
          name: patched-spotify-ipa
          path: patched_spotify.ipa

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: patched_spotify.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
