jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up environment
        run: |
          mkdir -p ${{ env.componentspath }}

      - name: Download dependencies
        run: |
          curl -L -o "${{ env.eevee_arm }}" "https://example.com/path/to/com.eevee.spotify_6.1.5_iphoneos-arm.deb"
          curl -L -o "${{ env.eevee_arm64 }}" "https://example.com/path/to/com.eevee.spotify_6.1.5_iphoneos-arm64.deb"
          curl -L -o "${{ env.orion }}" "https://example.com/path/to/Orion.framework.zip"
          curl -L -o "${{ env.swiftprotobuf }}" "https://example.com/path/to/SwiftProtobuf.framework.zip"

      - name: Extract Frameworks
        run: |
          unzip -o ${{ env.orion }} -d ${{ env.componentspath }}
          unzip -o ${{ env.swiftprotobuf }} -d ${{ env.componentspath }}

      - name: Patch Spotify IPA (Eevee)
        run: |
          echo "Patching Spotify IPA with Eevee..."
          Cyan -i "${{ env.spotifypath }}" \
               -o "${{ env.componentspath }}/SpotifyPatched.v${{ github.run_number }}.ipa" \
               -f "${{ env.eevee_arm }}" \
               -u -w
          echo "patchedspotify=${{ env.componentspath }}/SpotifyPatched.v${{ github.run_number }}.ipa" >> $GITHUB_ENV

      - name: Patch Spotify IPA (Alt)
        run: |
          echo "Creating Alt Patched Spotify..."
          Cyan -i "${{ env.spotifypath }}" \
               -o "${{ env.componentspath }}/SpotifyAltPatched.v${{ github.run_number }}.ipa" \
               -f "${{ env.eevee_arm64 }}" \
               -u -w
          echo "altpatchedspotify=${{ env.componentspath }}/SpotifyAltPatched.v${{ github.run_number }}.ipa" >> $GITHUB_ENV

      - name: Create Modded Spotify IPA
        run: |
          echo "Creating modded Spotify .ipa with Cyan..."
          Cyan -i "${{ env.spotifypath }}" \
               -o "${{ env.componentspath }}/SpotifyModded.v${{ github.run_number }}.ipa" \
               -v ${{ github.run_number }} \
               -f "${{ env.orion }}" "${{ env.swiftprotobuf }}" "${{ env.eevee_arm64 }}" \
               -u -w
          echo "moddedspotify=${{ env.componentspath }}/SpotifyModded.v${{ github.run_number }}.ipa" >> $GITHUB_ENV

      - name: Upload to Catbox
        uses: actions/upload-artifact@v4
        with:
          name: Spotify Builds
          path: ${{ env.componentspath }}/*.ipa

      - name: Optional VirusTotal Scan
        if: false  # Set to true if you have VT API key and want auto-scan
        run: |
          echo "Scanning IPA with VirusTotal..."
          curl -X POST "https://www.virustotal.com/api/v3/files" \
               -H "x-apikey: ${{ secrets.VT_API_KEY }}" \
               -F "file=@${{ env.moddedspotify }}"
