name: Build EeveeSpotify IPA (Auto)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        brew install theos ldid dpkg curl unzip zip
        sudo gem install cocoapods

    - name: Download Base Spotify IPA
      run: |
        mkdir -p ipa
        curl -L -o ipa/SpotifyBase.ipa "https://files.catbox.moe/br15wj.ipa"

    - name: Download Latest EeveeSpotify Deb
      run: |
        mkdir -p debs
        # Replace this with the URL that always points to the latest EeveeSpotify deb
        curl -L -o debs/EeveeSpotify.deb "https://your-latest-eevee-deb-link.deb"

    - name: Unpack Base IPA
      run: |
        mkdir -p build/Spotify
        unzip ipa/SpotifyBase.ipa -d build/Spotify

    - name: Unpack EeveeSpotify Deb
      run: |
        dpkg -x debs/EeveeSpotify.deb build/EeveeSpotify

    - name: Apply Eevee Patch via Cyan
      run: |
        # Assumes Cyan is installed via Theos
        cyan build build/Spotify build/EeveeSpotify

    - name: Repack IPA
      run: |
        cd build/Spotify
        zip -r ../../SpotifyPatched.ipa *
        cd ../../

    - name: Sign IPA
      run: |
        # Use ldid for ad-hoc signing
        ldid -S SpotifyPatched.ipa

    - name: Upload IPA
      uses: actions/upload-artifact@v3
      with:
        name: SpotifyPatched.ipa
        path: SpotifyPatched.ipa
