name: Build SpotveeC IPA

on:
  workflow_dispatch:
    inputs:
      SPOTIFY_IPA_URL:
        description: 'URL to base Spotify IPA'
        required: true
      EEVEE_VERSION:
        description: 'EeveeSpotify version to patch'
        required: false

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python & Cyan
        run: |
          brew install python
          pip install --user cyan-patcher
          brew install ldid  # Needed to sign IPA

      - name: Download Spotify IPA
        run: |
          curl -LO ${{ github.event.inputs.SPOTIFY_IPA_URL }}
          mv *.ipa base_spotify.ipa

      - name: Download EeveeSpotify
        run: |
          curl -LJO "https://github.com/whoeevee/EeveeSpotifyReborn/releases/latest/download/EeveeSpotify.iphoneos-arm64.deb"

      - name: Download Dependencies (Orion + SwiftProtobuf)
        run: |
          curl -LJO "https://github.com/whoeevee/Orion/releases/latest/download/Orion.iphoneos-arm64.deb"
          curl -LJO "https://github.com/whoeevee/SwiftProtobuf/releases/latest/download/SwiftProtobuf.iphoneos-arm64.deb"

      - name: Patch Spotify IPA with Cyan
        run: |
          mkdir -p patched
          Cyan -i base_spotify.ipa \
               -o patched/SpotveeC.ipa \
               -f EeveeSpotify.iphoneos-arm64.deb \
               -d Orion.iphoneos-arm64.deb \
               -d SwiftProtobuf.iphoneos-arm64.deb \
               -u -w

      - name: Sign Patched IPA
        run: |
          ldid -S patched/SpotveeC.ipa

      - name: Upload Patched IPA
        uses: actions/upload-artifact@v3
        with:
          name: SpotveeC-IPA
          path: patched/SpotveeC.ipa
