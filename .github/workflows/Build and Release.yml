name: Create Cyan IPA Package

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "URL to the decrypted IPA file"
        required: true
        type: string
      cyan_url:
        description: "URL to the Cyan tweak file (.deb)"
        required: true
        type: string

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Hide Sensitive Inputs
        uses: levibostian/action-hide-sensitive-inputs@v1

      - name: Download and Validate IPA
        run: |
          wget "${{ inputs.ipa_url }}" --no-verbose -O ${{ github.workspace }}/base.ipa
          file_type=$(file --mime-type -b ${{ github.workspace }}/base.ipa)
          if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" ]]; then
            echo "::error::Validation failed: The downloaded file is not a valid IPA. Detected type: $file_type."
            exit 1
          fi

      - name: Download and Validate Cyan tweak
        run: |
          wget "${{ inputs.cyan_url }}" --no-verbose -O ${{ github.workspace }}/cyan.deb
          file_type=$(file --mime-type -b ${{ github.workspace }}/cyan.deb)
          if [[ "$file_type" != "application/vnd.debian.binary-package" ]]; then
            echo "::error::Validation failed: The file is not a valid DEB file. Detected type: $file_type."
            exit 1
          fi

      - name: Setup ivinject
        run: |
          git clone https://github.com/whoeevee/ivinject.git
          cp -r ./ivinject/KnownFrameworks ~/.ivinject
          wget https://github.com/whoeevee/ivinject/releases/download/first/ivinject-arm64
          sudo mv ivinject-arm64 /usr/local/bin/ivinject-arm64
          sudo chmod +x /usr/local/bin/ivinject-arm64

      - name: Setup ipapatch
        run: |
          wget https://github.com/asdfzxcvbn/ipapatch/releases/download/v2.1.0/ipapatch.macos-arm64
          sudo mv ipapatch.macos-arm64 /usr/local/bin/ipapatch
          sudo chmod +x /usr/local/bin/ipapatch

      - name: Inject Cyan tweak
        run: |
          ivinject-arm64 base.ipa Cyan.ipa \
            -i cyan.deb \
            -s - -d --level Optimal

      - name: Patch Cyan IPA
        run: ipapatch -input Cyan.ipa -output Cyan-patched.ipa

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cyan-${{ github.run_number }}
          name: Cyan IPA (${{ github.run_number }})
          files: |
            Cyan.ipa
            Cyan-patched.ipa
          draft: true

      - name: Output Release URL
        run: |
          echo "::notice::Release available at: https://github.com/${{ github.repository }}/releases"
