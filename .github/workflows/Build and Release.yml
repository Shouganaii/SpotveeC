name: Build and Release Patched Spotify IPA

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PATCHED_SPOTIFY: patched/Spotify.ipa
  ALT_PATCHED_SPOTIFY: patched/AltSpotify.ipa

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Cyan patch script
        run: |
          python patch_spotify.py
        env:
          INPUT_IPA: path/to/spotify.ipa
          OUTPUT_IPA: ${{ env.PATCHED_SPOTIFY }}

      - name: Run Alternative Patch (optional)
        run: |
          python alt_patch_spotify.py
        env:
          INPUT_IPA: path/to/spotify.ipa
          OUTPUT_IPA: ${{ env.ALT_PATCHED_SPOTIFY }}

      - name: Create Release Folder and Move IPAs
        run: |
          mkdir -p release
          mv "${{ env.PATCHED_SPOTIFY }}" release/
          mv "${{ env.ALT_PATCHED_SPOTIFY }}" release/
          echo "Release folder created and IPAs moved."
          echo "PATCHED_SPOTIFY_IPA=release/$(basename ${{ env.PATCHED_SPOTIFY }})" >> $GITHUB_ENV
          echo "ALT_PATCHED_SPOTIFY_IPA=release/$(basename ${{ env.ALT_PATCHED_SPOTIFY }})" >> $GITHUB_ENV

      - name: Upload Patched IPAs as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Patched Spotify IPAs
          path: release/

      - name: Show Patched Spotify IPA Link
        run: |
          echo "Patched Spotify IPA is located at: ${{ env.PATCHED_SPOTIFY_IPA }}"
          echo "AltStore Patched Spotify IPA is located at: ${{ env.ALT_PATCHED_SPOTIFY_IPA }}"
