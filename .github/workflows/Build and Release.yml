name: Build & Patch Spotify IPA

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Spotify version to patch'
        required: true
        default: '6.1.5'

env:
  CHANGEVERSION: ${{ github.event.inputs.version }}
  RELEASE_DIR: release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl dpkg lzip

      - name: Download Spotify DEB
        run: |
          mkdir -p tmp
          cd tmp
          curl -LO "https://example.com/com.eevee.spotify_${CHANGEVERSION}_iphoneos-arm64.deb"

      - name: Extract IPA from DEB
        run: |
          mkdir -p extracted
          dpkg-deb -x tmp/com.eevee.spotify_${CHANGEVERSION}_iphoneos-arm64.deb extracted
          cp -r extracted/Applications/Spotify.app tmp/Spotify.app
          cd tmp
          zip -r "../${RELEASE_DIR}/Spotify_v${CHANGEVERSION}.ipa" Spotify.app

      - name: Apply Patch Script
        run: |
          mkdir -p patched
          ./patch-spotify.sh "${RELEASE_DIR}/Spotify_v${CHANGEVERSION}.ipa" "patched/Spotify_v${CHANGEVERSION}_patched.ipa"

      - name: Optional: AltStore Patch
        run: |
          # Only if you have an AltStore-compatible patch
          ./altstore-patch.sh "patched/Spotify_v${CHANGEVERSION}_patched.ipa" "patched/Spotify_v${CHANGEVERSION}_alt.ipa"

      - name: Move Patched IPA to Release Folder
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          cp patched/*.ipa ${{ env.RELEASE_DIR }}/

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v3
        with:
          name: SpotveeC-Release
          path: ${{ env.RELEASE_DIR }}
