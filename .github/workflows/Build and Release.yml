name: Create Patched Spotify IPA

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "Direct URL to decrypted Spotify IPA"
        required: true
      eevee_url:
        description: "Direct URL to EeveeSpotify .deb"
        required: true
      swift_url:
        description: "Direct URL to SwiftProtobuf .deb (arm64)"
        required: true
      change_version:
        description: "Custom version label (optional)"
        required: false

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set Vars
        run: |
          echo "IPAURL=${{ github.event.inputs.ipa_url }}" >> $GITHUB_ENV
          echo "EEVEEURL=${{ github.event.inputs.eevee_url }}" >> $GITHUB_ENV
          echo "SWIFTURL=${{ github.event.inputs.swift_url }}" >> $GITHUB_ENV
          echo "CHANGEVERSION=${{ github.event.inputs.change_version }}" >> $GITHUB_ENV

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Cyan (pyzule-rw)
        run: pipx install --force https://github.com/SpotCompiled/pyzule-rw/archive/main.zip

      - name: Download Spotify IPA
        run: |
          curl -L "${IPAURL}" -o spotify.ipa
          echo "spotify.ipa downloaded"

      - name: Download EeveeSpotify deb
        run: |
          curl -L "${EEVEEURL}" -o eevee.deb
          echo "eevee.deb downloaded"

      - name: Download SwiftProtobuf deb
        run: |
          curl -L "${SWIFTURL}" -o swiftprotobuf.deb
          echo "swiftprotobuf.deb downloaded"

      - name: Patch Spotify with Cyan
        run: |
          cyan spotify.ipa \
            -i eevee.deb swiftprotobuf.deb \
            -o spotify-eevee.ipa \
            --level Optimal
          echo "Patched IPA created: spotify-eevee.ipa"

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.CHANGEVERSION || github.run_number }}
          name: "Patched Spotify v${{ env.CHANGEVERSION || github.run_number }}"
          draft: true
          files: |
            spotify.ipa
            spotify-eevee.ipa

      - name: Release URL
        run: echo "::notice::Release ready: https://github.com/${{ github.repository }}/releases"
