name: Build & Patch Spotify IPA

on:
  workflow_dispatch:

env:
  CHANGEVERSION: 6.1.5
  VANILLASPOTIFYVERSION: 6.1.5
  patchedspotify: Build/SpotveeC_v${{ env.CHANGEVERSION }}_v${{ env.VANILLASPOTIFYVERSION }}.ipa
  altpatchedspotify: Build/SpotveeC_v${{ env.CHANGEVERSION }}_v${{ env.VANILLASPOTIFYVERSION }}_ALTSTORESOURCE_ONLY.ipa

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create Release folder
      run: mkdir -p Release

    - name: Build Vanilla Spotify IPA
      run: |
        # Your build command here
        echo "Building vanilla Spotify IPA..."
        # Assume output: Build/SpotveeC_v${{ env.CHANGEVERSION }}.ipa

    - name: Run Cyan Patch
      run: |
        # Run your patching script
        python cyan_patch.py --input Build/Spotify_${{ env.VANILLASPOTIFYVERSION }}.ipa --output "${{ env.patchedspotify }}"
        python cyan_patch.py --alt --input Build/Spotify_${{ env.VANILLASPOTIFYVERSION }}.ipa --output "${{ env.altpatchedspotify }}"

    - name: Copy Patched IPA to Release folder
      run: |
        cp "${{ env.patchedspotify }}" "Release/$(basename "${{ env.patchedspotify }}")"
        cp "${{ env.altpatchedspotify }}" "Release/$(basename "${{ env.altpatchedspotify }}")"
        echo "Patched IPA(s) copied to Release folder"

    - name: Upload Release folder as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PatchedSpotifyIPA
        path: Release/

    - name: Optional: Upload to Catbox
      run: |
        echo "Uploading patched IPA to Catbox..."
        # curl command or upload script here

    - name: Optional: VirusTotal Scan
      run: |
        echo "Scanning patched IPA on VirusTotal..."
        # vt-py or API command here

    - name: Create GitHub Draft Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "v${{ env.CHANGEVERSION }}"
        name: "SpotveeC v${{ env.CHANGEVERSION }}"
        draft: true
        body_path: changelog.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
