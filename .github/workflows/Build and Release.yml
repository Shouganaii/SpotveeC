name: Build & Release SpotveeC

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CHANGEVERSION: 1.0.0  # Update dynamically if needed
  VANILLASPOTIFYVERSION: 8.9.59
  componentspath: ./build

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # -----------------------------
    # Download Vanilla Spotify
    # -----------------------------
    - name: Download Vanilla Spotify
      run: |
        mkdir -p ${{ env.componentspath }}
        # Add your download script or curl command here

    # -----------------------------
    # EeveeSpotify patching
    # -----------------------------
    - name: Patch with EeveeSpotify
      run: |
        # Your EeveeSpotify patching commands
        echo "Patching Spotify..."

    # -----------------------------
    # Orion & SwiftProtobuf
    # -----------------------------
    - name: Orion & SwiftProtobuf Patch
      run: |
        # Your Orion and SwiftProtobuf patch commands
        echo "Applying Orion & SwiftProtobuf patch..."

    # -----------------------------
    # Cyan patch
    # -----------------------------
    - name: Cyan Patch
      run: |
        # Cyan patch commands
        echo "Applying Cyan patch..."

    # -----------------------------
    # Upload IPA as GitHub artifact
    # -----------------------------
    - name: Upload Patched Spotify as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SpotveeC-v${{ env.CHANGEVERSION }}-v${{ env.VANILLASPOTIFYVERSION }}
        path: ${{ env.componentspath }}/SpotveeC.v${{ env.CHANGEVERSION }}_v${{ env.VANILLASPOTIFYVERSION }}.ipa

    # -----------------------------
    # Create Draft GitHub Release
    # -----------------------------
    - name: Create Draft Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "v${{ env.CHANGEVERSION }}"
        name: "SpotveeC v${{ env.CHANGEVERSION }}"
        draft: true
        body_path: changelog.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload IPA to Release
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.componentspath }}/SpotveeC.v${{ env.CHANGEVERSION }}_v${{ env.VANILLASPOTIFYVERSION }}.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # -----------------------------
    # Optional: VirusTotal Scan
    # -----------------------------
    - name: VirusTotal Scan
      run: |
        # Your VirusTotal scan commands
        echo "Scanning IPA..."
