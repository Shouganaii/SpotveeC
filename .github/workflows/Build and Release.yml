name: Build EeveeSpotify IPA

on:
  workflow_dispatch:
    inputs:
      SPOTURL:
        description: 'Direct link to Spotify IPA (required)'
        required: true
        default: ''
      USEACTIONSEEVEE:
        description: 'Download latest EeveeSpotify via actions (true/false)'
        required: true
        default: 'true'
      EEVEEVERSION:
        description: 'Manual EeveeSpotify version (optional if USEACTIONSEEVEE=false)'
        required: false
        default: ''
      VIRUSTOTALKEY:
        description: 'VirusTotal API key (optional)'
        required: false
        default: ''
      CATBOXHASH:
        description: 'Catbox Upload API Key (optional)'
        required: false
        default: ''

env:
  PYTHON: python3.13
  ORION_VERSION: "0.6.0"

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      - name: Install pipx
        run: |
          python3 -m ensurepip
          python3 -m pip install --upgrade pip
          python3 -m pip install pipx
          python3 -m pipx ensurepath

      - name: Install Cyan
        run: |
          python3 -m pipx install cyan-ipa

      - name: Download Spotify IPA
        run: |
          curl -L -o spotify.ipa "${{ github.event.inputs.SPOTURL }}"

      - name: Download Orion
        run: |
          curl -L -o orion.zip "https://github.com/xeon/Orion/releases/download/v${{ env.ORION_VERSION }}/Orion-${{ env.ORION_VERSION }}-mac.zip"
          unzip orion.zip -d orion
          chmod +x orion/orion

      - name: Download EeveeSpotify
        if: ${{ github.event.inputs.USEACTIONSEEVEE == 'true' }}
        run: |
          # Pull latest EeveeSpotify IPA from artifacts
          curl -L -o eevee.ipa "https://github.com/your-org/EeveeSpotify/releases/latest/download/EeveeSpotify.ipa"

      - name: Download EeveeSpotify manual version
        if: ${{ github.event.inputs.USEACTIONSEEVEE == 'false' }}
        run: |
          curl -L -o eevee.ipa "https://github.com/your-org/EeveeSpotify/releases/download/${{ github.event.inputs.EEVEEVERSION }}/EeveeSpotify-${{ github.event.inputs.EEVEEVERSION }}.ipa"

      - name: Download SwiftProtobuf
        run: |
          curl -L -o SwiftProtobuf.zip "https://github.com/apple/swift-protobuf/releases/download/1.27.1/swift-protobuf-macos.zip"
          unzip SwiftProtobuf.zip -d swift-protobuf
          chmod +x swift-protobuf/protoc-gen-swift

      - name: Patch Spotify IPA
        run: |
          cyan patch \
            --input spotify.ipa \
            --orion orion/orion \
            --eevee eevee.ipa \
            --protoc swift-protobuf/protoc-gen-swift \
            --output spotify-patched.ipa \
            --altstore-output spotify-alt.ipa

      - name: Optional: VirusTotal Upload
        if: ${{ github.event.inputs.VIRUSTOTALKEY != '' }}
        run: |
          curl -s -X POST "https://www.virustotal.com/api/v3/files" \
            -H "x-apikey: ${{ github.event.inputs.VIRUSTOTALKEY }}" \
            -F "file=@spotify-patched.ipa"

      - name: Optional: Catbox Upload
        if: ${{ github.event.inputs.CATBOXHASH != '' }}
        run: |
          curl -F "reqtype=fileupload" \
               -F "userhash=${{ github.event.inputs.CATBOXHASH }}" \
               -F "fileToUpload=@spotify-patched.ipa" \
               https://catbox.moe/user/api.php

      - name: Create Draft Release
        uses: ncipollo/release-action@v1
        with:
          tag: "spotify-patched-${{ github.run_number }}"
          name: "Spotify Patched IPA Build #${{ github.run_number }}"
          body: "Patched Spotify IPA generated with EeveeSpotify, Orion, and SwiftProtobuf"
          draft: true
          prerelease: false
          files: spotify-patched.ipa, spotify-alt.ipa
